# Raspberry Pi TCP Chat & Video Streaming Program

λΌμ¦λ² λ¦¬νμ΄(Linux)μ™€ μλ„μ°(Windows) ν™κ²½μ„ λ¨λ‘ μ§€μ›ν•λ” **λ©€ν‹° μ¤λ λ“ κΈ°λ°μ TCP μ±„ν… λ° μ‹¤μ‹κ°„ μμƒ μ¤νΈλ¦¬λ° μ‹μ¤ν…**μ…λ‹λ‹¤.
μ„λ²„λ” C++ ν‘μ¤€ μ†μΌ“κ³Ό OpenCVλ¥Ό μ‚¬μ©ν•μ—¬ ν…μ¤νΈ μ¤‘κ³„ λ° μμƒ λ¦΄λ μ΄(Relay) κΈ°λ¥μ„ μν–‰ν•λ©°, ν΄λΌμ΄μ–ΈνΈλ” **CLI(Console)** λ²„μ „κ³Ό **GUI(Qt)** λ²„μ „ λ‘ κ°€μ§€λ¥Ό μ κ³µν•©λ‹λ‹¤.

## π€ μ£Όμ” κΈ°λ¥

### 1. ν…μ¤νΈ μ±„ν… (Port: 12345)
- **λ©€ν‹° μ μ € μ±„ν…:** λ‹¤μμ ν΄λΌμ΄μ–ΈνΈκ°€ λ™μ‹μ— μ ‘μ†ν•μ—¬ λ€ν™” κ°€λ¥ (μ¤λ λ“ μ²λ¦¬)
- **ν¬λ΅μ¤ ν”λ«νΌ:** Linux(Console) λ° Windows(Qt) κ°„ μ™„λ²½ν• λ©”μ‹μ§€ νΈν™
- **UI μµμ ν™”:**
    - **Console:** Non-canonical λ¨λ“(termios) μ μ©μΌλ΅ λ©”μ‹μ§€ μμ‹  μ‹ μ…λ ¥μ°½ κΉ¨μ§ λ°©μ§€
    - **Qt:** λ‹‰λ„¤μ„ κΈ°λ°μ μ§κ΄€μ μΈ GUI μ κ³µ
- **μ„λ²„ μ•λ¦Ό:** μ…μ¥/ν‡΄μ¥ λ° κ³µμ§€ μ‚¬ν•­ μ „μ†΅, μ ‘μ† λ΅κ·Έ νμΌ(`chat_log.txt`) μ €μ¥

### 2. μμƒ μ¤νΈλ¦¬λ° (Port: 9999)
- **μ‹¤μ‹κ°„ μ¤‘κ³„ (Relay Server):** ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄λ‚Έ μμƒμ„ μ„λ²„κ°€ λ°›μ•„ μ›Ή/μ•±μΌλ΅ μ¤‘κ³„
- **μ›Ή λ·°μ–΄ μ§€μ›:** λ³„λ„μ ν΄λΌμ΄μ–ΈνΈ μ„¤μΉ μ—†μ΄ μ›Ή λΈλΌμ°μ €μ—μ„ λ°”λ΅ μ‹μ²­ κ°€λ¥ (HTTP MJPEG Streaming)
    - μ ‘μ† μ£Όμ†: `http://<Server_IP>:9999/<Target_Nickname>`
- **μ–‘λ°©ν–¥ μμƒ (Qt):** Qt ν΄λΌμ΄μ–ΈνΈμ—μ„ λ³ΈμΈμ μ›ΉμΊ  μ†΅μ¶ λ° μƒλ€λ°©μ ν™”λ©΄ μμ‹  κ°€λ¥
- **OpenCV μ—°λ™:**
    - **Console:** V4L2 λ°±μ—”λ“λ¥Ό μ΄μ©ν• λΌμ¦λ² λ¦¬νμ΄ μΉ΄λ©”λΌ μΊ΅μ² λ° μ „μ†΅
    - **Qt:** Windows DirectShow(DSHOW)λ¥Ό μ΄μ©ν• μ›ΉμΊ  μΊ΅μ² λ° μ „μ†΅

## π“‚ λ””λ ‰ν† λ¦¬ κµ¬μ΅°
```text
.
β”β”€β”€ common/             # κ³µν†µ ν—¤λ” (defs.h: IP/Port, λ²„νΌ μ„¤μ • ν†µν•©)
β”β”€β”€ server/             # μ±„ν… λ° μμƒ μ¤‘κ³„ μ„λ²„ (Multi-threaded)
β”β”€β”€ client/             # μ½μ†”μ© ν΄λΌμ΄μ–ΈνΈ (OpenCV + Socket)
β”β”€β”€ client_qt/          # GUI ν΄λΌμ΄μ–ΈνΈ (Qt + OpenCV)
β”β”€β”€ Makefile            # ν†µν•© λΉλ“ μ¤ν¬λ¦½νΈ (Server & Console Client)
β””β”€β”€ README.md           # ν”„λ΅μ νΈ λ¬Έμ„
```

## π› οΈ μ‹μ¤ν… κµ¬μ΅° (Architecture)
```mermaid
graph LR
    A[Client A (Cam)] -->|Upload MJPEG| S(Server / Relay Hub)
    B[Client B (Cam)] -->|Upload MJPEG| S
    S -->|Stream HTTP| W[Web Browser]
    S -->|Stream TCP| Q[Qt Client (Viewer)]
```

## π—οΈ λΉλ“ λ° μ‹¤ν–‰ λ°©λ²•

### μ‚¬μ „ μ”κµ¬ μ‚¬ν•­ (Prerequisites)
- **OpenCV 4.x** (Server, Client κ³µν†µ ν•„μ)
- **Qt 5 λλ” 6** (GUI ν΄λΌμ΄μ–ΈνΈμ©)

### 1. μ„λ²„ λ° μ½μ†” ν΄λΌμ΄μ–ΈνΈ (Raspberry Pi / Linux)
```bash
# λΉλ“ (OpenCV λΌμ΄λΈλ¬λ¦¬ λ§ν¬ ν¬ν•¨)
make

# μ„λ²„ μ‹¤ν–‰ (λ°±κ·ΈλΌμ΄λ“)
./chat_server &

# μ½μ†” ν΄λΌμ΄μ–ΈνΈ μ‹¤ν–‰ (μΉ΄λ©”λΌ μ†΅μ¶ ν¬ν•¨)
./chat_client_console <λ‹‰λ„¤μ„>
# μΆ…λ£ μ‹: μ±„ν…μ°½μ— '/q' μ…λ ¥
```

### 2. GUI ν΄λΌμ΄μ–ΈνΈ (Windows / Qt Creator)
1. `client_qt/chat-client.pro` ν”„λ΅μ νΈ μ—΄κΈ°.
2. `mainwindow.cpp` λ° `defs.h`(ν•„μ”μ‹)μ μ„λ²„ IP μ£Όμ† ν™•μΈ.
3. **Build & Run**.
4. λ‹‰λ„¤μ„ μ…λ ¥ ν›„ **[μ—°κ²°]** ν΄λ¦­ (μ±„ν… λ° μμƒ μ†΅μ¶ μ‹μ‘).
5. μƒλ€λ°© λ‹‰λ„¤μ„ μ…λ ¥ ν›„ **[λ³΄κΈ°]** ν΄λ¦­ (μƒλ€λ°© ν™”λ©΄ μμ‹ ).

## π“ νΈλ¬λΈ”μν… λ° κΈ°μ μ  ν•΄κ²° (Troubleshooting)

κ°λ° κ³Όμ •μ—μ„ λ°μƒν• μ£Όμ” μ΄μμ™€ ν•΄κ²° λ°©λ²•μ…λ‹λ‹¤.

### 1. μ„λ²„/ν΄λΌμ΄μ–ΈνΈ λ™μ‹ μΆ…λ£ ν„μƒ (Broken Pipe)
* **ν„μƒ:** μ›Ή λΈλΌμ°μ €(Viewer)λ¥Ό λ‹«κ±°λ‚ ν΄λΌμ΄μ–ΈνΈ μ—°κ²°μ΄ λκΈ°λ©΄ μ„λ²„ ν”„λ΅μ„Έμ¤κ°€ ν•¨κ» μ‚¬λ§.
* **μ›μΈ:** λμ–΄μ§„ μ†μΌ“μ— `send()` μ‹λ„ μ‹ OSκ°€ `SIGPIPE` μ‹κ·Έλ„μ„ λ³΄λ‚΄ ν”„λ΅μ„Έμ¤λ¥Ό κ°•μ  μΆ…λ£μ‹ν‚΄.
* **ν•΄κ²°:**
    * `main()` μ‹μ‘ μ‹ `signal(SIGPIPE, SIG_IGN);` μ¶”κ°€ν•μ—¬ μ‹κ·Έλ„ λ¬΄μ‹.
    * μ†μΌ“ μ „μ†΅ μ‹ `send(..., MSG_NOSIGNAL)` ν”λκ·Έ μ‚¬μ©.

### 2. μΆ…λ£ μ‹ Segmentation Fault (Race Condition)
* **ν„μƒ:** ν΄λΌμ΄μ–ΈνΈμ—μ„ `/q`λ΅ μΆ…λ£ μ‹ λ©”λ¨λ¦¬ μ°Έμ΅° μ¤λ¥ λ°μƒ.
* **μ›μΈ:** λ©”μΈ μ¤λ λ“κ°€ μΆ…λ£λλ©΄μ„ λ©”λ¨λ¦¬λ¥Ό ν•΄μ ν•λ” λ„μ¤‘, λ°±κ·ΈλΌμ΄λ“ μμƒ μ¤λ λ“κ°€ μμ›μ— μ ‘κ·Όν•μ—¬ μ¶©λ.
* **ν•΄κ²°:** `std::atomic<bool>` ν”λκ·Έλ¥Ό λ„μ…ν•μ—¬ μΆ…λ£ μ‹ νΈλ¥Ό λ³΄λ‚΄κ³ , μ¤λ λ“κ°€ μ•μ „ν•κ² λ£¨ν”„λ¥Ό νƒμ¶ν•  λ•κΉμ§€ λ€κΈ°(`usleep`/`join`) ν›„ ν”„λ΅κ·Έλ¨ μΆ…λ£.

### 3. μ…λ ¥ λ²„νΌ λ®μ–΄μ”μ›€ (Console UX)
* **ν„μƒ:** μ±„ν… μ…λ ¥ λ„μ¤‘ λ©”μ‹μ§€λ¥Ό μμ‹ ν•λ©΄ μ…λ ¥ν•λ ν…μ¤νΈκ°€ κΉ¨μ§€κ±°λ‚ μ¤„λ°”κΏμ΄ κΌ¬μ„.
* **ν•΄κ²°:** `termios` μ„¤μ •μ„ ν†µν•΄ ν„°λ―Έλ„μ„ **Non-canonical λ¨λ“**λ΅ μ „ν™ν•κ³ , `getch()` κµ¬ν„ λ° μ…λ ¥ λ²„νΌ(`current_input`)λ¥Ό λ³„λ„λ΅ κ΄€λ¦¬ν•μ—¬ ν™”λ©΄ κ°±μ‹  μ‹ λ³µκµ¬ν•λ„λ΅ κµ¬ν„.

### 4. Windows Qt μΉ΄λ©”λΌ νΈν™μ„±
* **ν„μƒ:** Qt ν΄λΌμ΄μ–ΈνΈμ—μ„ μ›ΉμΊ μ΄ μ—΄λ¦¬μ§€ μ•μ.
* **ν•΄κ²°:** `cv::VideoCapture` μ΄κΈ°ν™” μ‹ `cv::CAP_DSHOW` (DirectShow) APIλ¥Ό λ…μ‹μ μΌλ΅ νΈμ¶ν•μ—¬ μλ„μ° νΈν™μ„± ν™•λ³΄.

## β… κ°λ° ν™κ²½
- **OS:** Raspberry Pi OS (Linux), Windows 10/11
- **Language:** C++14
- **Framework:** Qt 6 (Widgets, Network), OpenCV 4.5.5
- **Concurrency:** POSIX Threads (pthread), std::thread, QtThread
- **Network:** TCP/IP Sockets

## π“… μ—…λ°μ΄νΈ λ‚΄μ—­ (Change Log)
- **[Feat]** Qt GUI ν΄λΌμ΄μ–ΈνΈ μ–‘λ°©ν–¥ μμƒ μ†΅μμ‹  κµ¬ν„ (Sender/Receiver μ¤λ λ“ λ¶„λ¦¬)
- **[Feat]** μ„λ²„ μ›Ή μ¤νΈλ¦¬λ°(HTTP MJPEG) μ§€μ› λ° URL λΌμ°ν… κµ¬ν„
- **[Refactor]** IP/Port μ„¤μ • `defs.h`λ΅ μ¤‘μ•™ν™”
- **[Fix]** `SIGPIPE` ν•Έλ“¤λ§ λ° μ¤λ λ“ μ•μ „ μΆ…λ£(`Atomic Flag`) μ μ©